# 外設

## 什麼是外設?

大多數微處理器不僅僅有一個CPU，RAM，或者Flash存儲器 - 它們還包含被用來與微處理器的外部系統進行交互的硅片部分，通過傳感器，電機控制器，或者人機接口比如一個顯示器或者鍵盤直接和間接地與周遭世界交互。這些組件統稱為外設。

這些外設很有用，因為它們允許一個開發者將處理工作交給它們來做，避免了必須在軟件中處理每件事。就像一個桌面開發者如何將圖形處理工作讓給一個顯卡那樣，嵌入式開發者能將一些任務讓給外設去做，讓CPU可以把時間放在做其它更重要的事上，或者為了省電啥事也不做。

如果你看向來自1970s或者1980s的舊型號的家庭電腦的主板(其實，昨日的桌面PCs與今日的嵌入式系統沒太大區別)，你將看到:

* 一個處理器
* 一個RAM芯片
* 一個ROM芯片
* 一個I/O控制器

RAM芯片，ROM芯片和I/O控制器(這個系統中的外設)會通過一系列並行的跡(traces)又被稱為一個"總線"被加進處理器中。地址總線搬運地址信息，其用來選擇處理器希望跟總線上哪個設備通信，還有一個用來搬運實際數據的數據總線。在我們的嵌入式微控制器中，應用了相同的概念 - 只是所有的東西被打包到一片硅片上。

然而，不像顯卡，顯卡通常有像是Vulkan，Metal，或者OpenGL這樣的一個軟件API。外設暴露給微控制器的是一個硬件接口，其被映射到一塊存儲區域。

## 線性的物理存儲空間

在一個微控制器上，隨便往一些地址寫一些數據，比如 `0x4000_0000` 或者 `0x0000_0000`，可能也是一個完全有效的動作。

在一個桌面系統上，訪問內存被MMU，或者內存管理單元緊緊地控制著。這個組件有兩個主要責任: 對部分內存加入訪問權限(防止一個進程讀取或者修改另一個進程的內存)；重映射物理內存的段到軟件中使用的虛擬內存範圍上。微控制器通常沒有一個MMU，反而在軟件中只使用真實的物理地址。

雖然32位微控制器有一個從`0x0000_0000`到`0xFFFF_FFFF`的線性的物理地址空間，但是它們通常只使用幾百KiB的實際內存。有相當大部分的地址空間保留著。在早期的章節中，我們說到RAM被放置在地址`0x2000_0000`處。如果我們的RAM是64KiB大小(i.e. 最大地址為0xFFFF),那麼地址 `0x2000_0000`到`0x2000_FFFF`與我們的RAM有關。當我們寫入一個位於地址`0x2000_1234`的變量時，內部發生的是，一些邏輯發現了地址的上部(這個例子裡是0x2000)，然後激活RAM，以便能操作地址的下部(這個例子裡是0x1234)。在一個Cortex-M上，我們也也會把Flash ROM映射進地址 `0x000_0000` 到地址 `0x0007_FFFF` 上 (如果我們有一個512KiB Flash ROM)。微控制器設計者沒有忽略這兩個區域間的所有剩餘空間，反而將外設的接口映射到這些地址上。最後看起來像這樣:

![](../assets/nrf52-memory-map.png)

[Nordic nRF52832 Datasheet (pdf)]

## 存儲映射的外設

乍一看，與這些外設交互很簡單 - 將正確的數據寫入正確的地址。比如，在一個串行端口上發送一個32位字，可以直接把那個32位字寫入某個存儲地址。串行端口外設然後能自動獲取和發出數據。

這些外設的配置工作相似。不是調用一個函數去配置一個外設，而是暴露一塊地址空間作為硬件API。向一個SPI頻率控制寄存器寫入 `0x8000_0000`，SPI端口將會按照每秒8MB的速度發送數據。向同個地址寫入 `0x0200_0000`，SPI端口將會按照每秒125KiB的速度發送數據。這些配置寄存器看起來有點像這個:

![](../assets/nrf52-spi-frequency-register.png)

[Nordic nRF52832 Datasheet (pdf)]

這個接口是關於如何與硬件交互的，其與被使用的語言無關，無論這個語言是彙編，C，或者Rust。

[Nordic nRF52832 Datasheet (pdf)]: http://infocenter.nordicsemi.com/pdf/nRF52832_PS_v1.1.pdf
